<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="blockt-prepaidmake">
  <template>
    <style is="custom-style" include="shared-styles"></style>

      <div class="container">

          <h3>Create invite code</h3>
          <p>You are about to create an invite code. Tap the heart, fool !</p>
          <img src="http://legendsrevealed.com/entertainment/wp-content/uploads/2015/05/ba-baracus.jpg">
          <paper-icon-button toggles icon="favorite" on-tap="doMakeInvite"></paper-icon-button>
          <template is="dom-if" if="{{invitecode}}">
          Your invite code is: <paper-button raised on-tap="goClaim">{{invitecode}}</paper-button>
          Click the button fool !
          </template>

      </div>  
</template>

<script>
    (function() {
      'use strict';
      
      Polymer({
        is: 'blockt-prepaidmake',

        properties: {
          web3: {
            type: Object,
            observer: '_web3'
          },
          account: {
            type: String
          }
        },

        ready: function(){
        },

        close: function(){
        },

        _web3: function(){

        },

        doMakeInvite: function() {
          console.log('MAKE INVITE');

          var secretSeed = lightwallet.keystore.generateRandomSeed();

          lightwallet.keystore.deriveKeyFromPassword('test', function(err, pwDerivedKey) {

            var keystore = new lightwallet.keystore(secretSeed, pwDerivedKey);
            keystore.generateNewAddress(pwDerivedKey, 1);

            this.publickey = keystore.getAddresses()[0];
            this.privatekey = keystore.exportPrivateKey(this.publickey, pwDerivedKey);

            // create the pre-paid contract
            this._createContract();


          }.bind(this));
        },

 fixaddress: function(address) {
        function strStartsWith(str, prefix) {
          return str.indexOf(prefix) === 0;
        }

        if (!strStartsWith(address, '0x')) {
          return ('0x' + address);
        }
        return address;
      },

    _createContract: function(hash, fn) {
      var self = this;
      this.contracturl = this.resolveUrl('../../contracts/BlockTubePrepaid.json');
      this.importHref(this.contracturl, function(e) {

        var contractjson = JSON.parse(e.target.import.body.innerText);


        var blocktubeprepaidContract = this.web3.eth.contract(contractjson.abi);
        var blocktubeprepaid = blocktubeprepaidContract.new({
          from: this.fixaddress(this.account),
          data: contractjson.bytecode,
          gas: 3000000,
          value: this.web3.toWei('0.1', 'ether')
        }, function(e, contract) {
          console.log(e, contract);
          if (typeof contract.address !== 'undefined') {
            console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);

            this.prepaidcontractaddress = contract.address;
            this.invitecode = this.publickey + '-' + this.privatekey + '-' + this.prepaidcontractaddress            
          }
        }.bind(this));

      }, function(e) {
        console.log('ERROR!', e);
      });

    },


        goClaim: function(){
          Excess.RouteManager.transitionTo('/claiminvite/'+this.invitecode);
        }

      });
    })();
  </script>

</dom-module>